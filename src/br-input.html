<link rel="import" type="html" href="../../polymer/polymer.html">

<dom-module id="br-input">

  <script src="../../vanilla-masker/vanilla-masker.min.js"></script>

  <template> 
    <div class="form_field">
      <label for="{{name}}">{{label}}</label>
      <input type="text" id="{{name}}" on-blur="_validate" on-keyup='_onKeyPress'>      
      <template is="dom-if" if="{{hasNotEmptyError}}"><p>{{notEmptyErrorMessage}}</p></template>
      <template is="dom-if" if="{{hasMinLengthError}}"><p>{{minLengthErrorMessage}}</p></template>
      <template is="dom-if" if="{{hasMaxLengthError}}" ><p>{{maxLengthErrorMessage}}</p></template>
      <template is="dom-if" if="{{hasCustomError}}"><p>{{customErrorMessage}}</p></template>
    </div>
  </template>

  <script>
    
    Polymer({
      is: 'br-input',
      properties: {
        
        name: String,
        format: String,
        options: {
          type: Object,
          value: {}
        },
        formats: {
          type: Object,
          readOnly: true,
          value: {
            TEXT: 'TEXT',
            NUMBER: 'NUMBER',
            MONEY: 'MONEY',
            DATEMONTH: 'DATEMONTH',
            CPF: 'CPF',
            CNPJ: 'CNPJ'
          }
        },
        model: {
          type: String,
          notify: true
        },      
        required: {
          type: Boolean,
          default: false
        },
        isValid: {
          type: Boolean,
          default: true
        },
        min: Number,
        max: Number,
        notEmptyErrorMessage: String,
        minLengthErrorMessage: String,
        maxLengthErrorMessage: String,
        customErrorMessage: String,
        hasNotEmptyError: {
          type: Boolean,
          readOnly: true,
          default: false
        },
        hasMinLengthError: {
          type: Boolean,
          readOnly: true,
          default: false
        },
        hasMaxLengthError: {
          type: Boolean,
          readOnly: true,          
          default: false
        },
        hasCustomError: {
          type: Boolean,
          readOnly: true,
          default: false
        },
      },

      /* -- Lifecycle ------------------------------------------------- */

      ready: function(){  
        this._setInputMask();  
      },

      /* -- Private Methods ------------------------------------------- */
    
      _setInputMask: function(){

         var inputName = document.getElementById(this.name);

         switch(this.format.toUpperCase())
         {
          case this.formats.NUMBER:
            this._toNumber(inputName);
            break;
          case this.formats.MONEY:
            this._toMoney(inputName, this.options);
            break;
          case this.formats.DATEMONTH:
            this._toDateMonth(inputName);
            break;
          case this.formats.CPF:
            this._toCpf(inputName);
            break;
          case this.formats.CNPJ:
            this._toCnpj(inputName);
            break;
          default:
            break;

        }
      },

      _toNumber: function(inputName){
        VMasker(inputName).maskNumber();
      },

      _toMoney: function(inputName, options){
        VMasker(inputName).maskMoney(options);
      },

      _toDateMonth: function(inputName){
        VMasker(inputName).maskPattern("99/9999");
      },

      _toCpf: function(inputName){
        VMasker(inputName).maskPattern("999.999.999-99");
      },

      _toCnpj: function(inputName){
        VMasker(inputName).maskPattern("99.999.999/9999-99");
      },

      _onKeyPress: function(e){

        var input = document.getElementById(this.name);
        input.parentElement.children[0].classList.add('active');

        if(input.value.length === 0)
          input.parentElement.children[0].classList.remove('active');

        this.model = e.target.value;

        this._defaultValidation();
      },

      _validate: function(){

        this._defaultValidation();
        this._customValidation();

      },

      _defaultValidation: function(){

        var input = document.getElementById(this.name);

        this._validateNotEmpty(input);

        this._validateMinLength(input);

        this._validateMaxLength(input);

        if(this.hasMinLengthError || this.hasMaxLengthError || this.hasCustomError)
          input.classList.add('error');
        else
          input.classList.remove('error');
        
      },

      _customValidation: function() {

        var input = document.getElementById(this.name);

        
        if(this.isValid)
          this._setHasCustomError(false);
        else
          this._setHasCustomError(true);

        if(this.hasMinLengthError || this.hasMaxLengthError || this.hasCustomError)
          input.classList.add('error');
        else
          input.classList.remove('error');

      },

      _validateNotEmpty: function(input) { 

        if(this.required && input.value.length === 0)
          this._setHasNotEmptyError(true);        
        else
          this._setHasNotEmptyError(false);
        
      },

      _validateMinLength: function(input){

        if((this.format.toUpperCase() === this.formats.NUMBER  
          || this.format.toUpperCase() === this.formats.TEXT)
          &&  input.value.length < this.min)
        {
          this._setHasMinLengthError(true);          
        } 
        else
          this._setHasMinLengthError(false);
      },

      _validateMaxLength: function(input){
        
        if((this.format.toUpperCase() === this.formats.NUMBER  
            || this.format.toUpperCase() === this.formats.TEXT)
            &&  input.value.length > this.max)
        {
          this._setHasMaxLengthError(true);
        }
        else
          this._setHasMaxLengthError(false);
     },
 

     /* -- Public Methods -------------------------------------------- */

   });
  </script>

</dom-module>