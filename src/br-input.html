<link rel="import" type="html" href="../../br-icons/src/br-icons.html">
<dom-module id="br-input">
  <script src="../../vanilla-masker/build/vanilla-masker.min.js"></script>
  <template>
    <template is="dom-if" if="{{icon}}">
      <br-icons icon$="{{icon}}" class="icon"></br-icons>
    </template>
    <label for$="{{name}}">{{label}}</label>
    <input type$="{{brType}}"
            id$="{{name}}"
            value="{{value}}"
            on-keydown="_onKeyDown"
            on-focus="_activeField"
            on-blur="_deactiveField"
            on-change="_onChange"
            on-input="_onInput"
            maxlength$="{{max}}"
            required$="{{required}}"
            tabindex="0"
            autocorrect="off"
            autocapitalize="off"
           disabled$="{{disabled}}">
    <template is="dom-if" if="{{hasNotEmptyError}}">
      <p class="form_field--error">{{notEmptyErrorMessage}}</p>
    </template>
    <template is="dom-if" if="{{hasMinLengthError}}">
      <p class="form_field--error">{{minLengthErrorMessage}}</p>
    </template>
    <template is="dom-if" if="{{hasCustomError}}">
      <p class="form_field--error">{{customErrorMessage}}</p>
    </template>
  </template>
  <script>
    Polymer( {
      is: 'br-input',
      properties: {
        name: String,
        format: {
          type: String,
          value: "text"
        },
        brType: {
          type: String,
          value: "text"
        },
        icon: String,
        options: {
          type: Object,
          value: {}
        },
        formats: {
          type: Object,
          readOnly: true,
          value: {
            TEXT: 'TEXT',
            NUMBER: 'NUMBER',
            MONEY: 'MONEY',
            DATE: 'DATE',
            DATEMONTH: 'DATEMONTH',
            PHONE: 'PHONE',
            CPF: 'CPF',
            CNPJ: 'CNPJ'
          }
        },
        model: {
          type: String,
          reflectToAttribute: true,
          observer: '_modelChanged'
        },
        required: {
          type: Boolean,
          value: false
        },
        isValid: {
          type: String,
          value: "true"
        },
        min: Number,
        max: Number,
        notEmptyErrorMessage: String,
        minLengthErrorMessage: String,
        customErrorMessage: String,
        disabled: Boolean
      },

      /* -- Lifecycle ------------------------------------------------- */

      ready: function () {
        this.hasNotEmptyError = false;
        this.hasMinLengthError = false;
        this.hasCustomError = false;
        this.isValidForm = true;
        this.classList.add( 'form_field' );
      },

      /* -- Private Methods ------------------------------------------- */

      _setInputMask: function () {

        var inputName = this.$$( 'input' );

        switch ( this.format.toUpperCase() ) {
          case this.formats.NUMBER:
            this._toNumber( inputName );
            break;
          case this.formats.MONEY:
            this._toMoney( inputName, this.options );
            break;
          case this.formats.DATE:
            this._toDate( inputName );
            break;
          case this.formats.DATEMONTH:
            this._toDateMonth( inputName );
            break;
          case this.formats.CPF:
            this._toCpf( inputName );
            break;
          case this.formats.CNPJ:
            this._toCnpj( inputName );
            break;
          case this.formats.PHONE:
            this._toPhone( inputName );
            break;
          default:
            break;
        }
      },

      _toNumber: function ( inputName ) {
        VMasker( inputName ).maskNumber();
      },

      _toMoney: function ( inputName, options ) {
        VMasker( inputName ).maskMoney( options );
      },

      _toDateMonth: function ( inputName ) {
        VMasker( inputName ).maskPattern( "99/9999" );
      },

      _toDate: function ( inputName ) {
        VMasker( inputName ).maskPattern( "99/99/9999" );
      },

      _toCpf: function ( inputName ) {
        VMasker( inputName ).maskPattern( "999.999.999-99" );
      },

      _toCnpj: function ( inputName ) {
        VMasker( inputName ).maskPattern( "99.999.999/9999-99" );
      },

      _toPhone: function ( inputName ) {
        VMasker( inputName ).maskPattern( "99 99999-9999" );
      },

      _onInput: function ( e ) {
        this._validate();
        this._setInputMask();
        this._setModel();
      },

      _onChange: function ( e ) {
        this._setModel();
      },

      _onKeyDown: function ( e ) {
        if ( e.keyCode === 13 )
          this._setModel();
      },

      _activeField: function () {
        if ( !this.classList.contains( 'active' ) )
          this.classList.add( 'active' );
      },

      _deactiveField: function () {
        if ( this.classList.contains( 'active' ) && !this.model )
          this.classList.remove( 'active' );
      },

      _validate: function () {
        this._customValidation();
        this._defaultValidation();
      },

      _defaultValidation: function () {
        var input = this.$$( 'input' );

        this._validateNotEmpty( input );

        if ( this.min !== undefined )
          this._validateMinLength( input );
      },

      _customValidation: function () {
        if ( this.isValid === "true" ) {
          this.hasCustomError = false;
          this.isValidForm = true;
          this.classList.remove( 'is-invalid' );
        }
        else {
          this.hasCustomError = true;
          this.isValidForm = false;
          this.classList.add( 'is-invalid' );
        }
      },

      _validateNotEmpty: function ( input ) {
        if ( this.required && input.value.length === 0 ) {
          this.hasNotEmptyError = true;
          this.isValidForm = false;
          this.classList.add( 'is-invalid' );
        }
        else {
          this.hasNotEmptyError = false;
          this.isValidForm = true;
          this.classList.remove( 'is-invalid' );
        }
      },

      _validateMinLength: function ( input ) {
        if ( ( this.format.toUpperCase() === this.formats.NUMBER
          || this.format.toUpperCase() === this.formats.TEXT )
          && input.value.length < this.min ) {
          this.hasMinLengthError = true;
          this.isValidForm = false;
          this.classList.add( 'is-invalid' );
        }
        else {
          this.hasMinLengthError = false;
          this.isValidForm = true;
          this.classList.remove( 'is-invalid' );
        }
      },

      _setModel: function () {
        this.model = this.$$( 'input' ).value;

        if ( this.format.toUpperCase() === this.formats.MONEY )
          this.model = this.model.replace( /\./g, '' ).replace( ',', '.' );
      },

      _setValue: function () {
        this.value = this.model;

        if ( this.format.toUpperCase() === this.formats.MONEY )
          this.value = this.model.replace( '.', '' );

        this._setInputMask();
      },

      _modelChanged: function () {
        this.async( function () {

          if ( !!this.model ) {
            this._activeField();
          }
          else if ( this.model === '' ) {
            this._deactiveField();
          }

          this._setValue();
        } );
      }


      /* -- Public Methods -------------------------------------------- */

    } );
  </script>
</dom-module>