<link rel="import" type="html" href="../../br-icons/src/br-icons.html">

<dom-module id="br-input">

  <script src="../../vanilla-masker/build/vanilla-masker.min.js"></script>

  <template>
    <div class="form_field" required$="{{required}}">
      <template is="dom-if" if="{{icon}}">
        <br-icons icon$="{{icon}}" class="icon"></br-icons>
      </template>
      <label for$="{{name}}">{{label}}</label>
      <input type$="{{type}}" id$="{{name}}" autocorrect="off" autocapitalize="off" value$="{{model}}" on-blur="_validate" on-input='_onInput' on-focus='_activeField' maxlength$="{{max}}" required$="{{required}}" tabindex="0">
      <template is="dom-if" if="{{hasNotEmptyError}}"><p class="form_field--error">{{notEmptyErrorMessage}}</p></template>
      <template is="dom-if" if="{{hasMinLengthError}}"><p class="form_field--error">{{minLengthErrorMessage}}</p></template>
      <template is="dom-if" if="{{hasCustomError}}"><p class="form_field--error">{{customErrorMessage}}</p></template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'br-input',
      properties: {

        name: String,
        format: {
          type: String,
          value: "text"
        },
        type: {
          type: String,
          value: "text"
        },
        icon: String,
        options: {
          type: Object,
          value: {}
        },
        formats: {
          type: Object,
          readOnly: true,
          value: {
            TEXT: 'TEXT',
            NUMBER: 'NUMBER',
            MONEY: 'MONEY',
            DATE: 'DATE',
            DATEMONTH: 'DATEMONTH',
            PHONE: 'PHONE',
            CPF: 'CPF',
            CNPJ: 'CNPJ'
          }
        },
        model: {
          type: String,
          reflectToAttribute: true
        },
        brValue: String,
        required: {
          type: Boolean,
          value: false
        },
        isValid: {
          type: String,
          value: "true"
        },
        min: Number,
        max: Number,
        notEmptyErrorMessage: String,
        minLengthErrorMessage: String,
        customErrorMessage: String,
      },

      /* -- Lifecycle ------------------------------------------------- */

      ready: function() {
        this.hasNotEmptyError = false;
        this.hasMinLengthError = false;
        this.hasCustomError = false;
        this.isValidForm = false;

        this._setInputMask();
      },

      /* -- Private Methods ------------------------------------------- */

      _setInputMask: function() {

         var inputName = this.$$('input');

         switch(this.format.toUpperCase())
         {
          case this.formats.NUMBER:
            this._toNumber(inputName);
            break;
          case this.formats.MONEY:
            this._toMoney(inputName, this.options);
            break;
          case this.formats.DATE:
            this._toDate(inputName);
            break;
          case this.formats.DATEMONTH:
            this._toDateMonth(inputName);
            break;
          case this.formats.CPF:
            this._toCpf(inputName);
            break;
          case this.formats.CNPJ:
            this._toCnpj(inputName);
            break;
          case this.formats.PHONE:
            this._toPhone(inputName);
            break;
          default:
            break;
        }
      },

      _toNumber: function(inputName) {
        VMasker(inputName).maskNumber();
      },

      _toMoney: function(inputName, options) {
        VMasker(inputName).maskMoney(options);
      },

      _toDateMonth: function(inputName) {
        VMasker(inputName).maskPattern("99/9999");
      },

      _toDate: function(inputName) {
        VMasker(inputName).maskPattern("99/99/9999");
      },

      _toCpf: function(inputName) {
        VMasker(inputName).maskPattern("999.999.999-99");
      },

      _toCnpj: function(inputName) {
        VMasker(inputName).maskPattern("99.999.999/9999-99");
      },

       _toPhone: function(inputName) {
        VMasker(inputName).maskPattern("(99) 99999-9999");
      },

      _onInput: function(e) {       
        
        this._activeField();        
        this.model = e.target.value;                
        this._defaultValidation();
        this._validate();
      },

      _activeField: function(){
        var formFieldClassList = this.$$('.form_field').classList;
         
        if(!formFieldClassList.contains('active'))
          formFieldClassList.add('active');
      },

      _validate: function() {
        this._customValidation();
        this._defaultValidation();

        var input = this.$$('input');
        if(input.value.length === 0)
          this.$$('.form_field').classList.remove('active');
      },

      _defaultValidation: function() {

        var input = this.$$('input');

        this._validateNotEmpty(input);

        if(this.min !== undefined)
          this._validateMinLength(input);
      },

      _customValidation: function() {

        var formField = this.$$('.form_field');

        if (this.isValid === "true"){
          this.hasCustomError = false;
          this.isValidForm = true;
          formField.classList.remove('is-invalid');
        }
        else{
          this.hasCustomError = true;
          this.isValidForm = false;
          formField.classList.add('is-invalid');
        }
      },

      _validateNotEmpty: function(input) {

        var formField = this.$$('.form_field');

        if(this.required && input.value.length === 0){
          this.hasNotEmptyError = true;
          this.isValidForm = false;
          formField.classList.add('is-invalid');
        }
        else{
          this.hasNotEmptyError = false;
          this.isValidForm = true;
          formField.classList.remove('is-invalid');
        }
      },

      _validateMinLength: function(input) {

        var formField = this.$$('.form_field');

        if ((this.format.toUpperCase() === this.formats.NUMBER
          || this.format.toUpperCase() === this.formats.TEXT)
          &&  input.value.length < this.min)
        {
          this.hasMinLengthError = true;
          this.isValidForm = false;
          formField.classList.add('is-invalid');
        }
        else{
          this.hasMinLengthError = false;
          this.isValidForm = true;
          formField.classList.remove('is-invalid');
        }
      },


     /* -- Public Methods -------------------------------------------- */

   });
  </script>

</dom-module>